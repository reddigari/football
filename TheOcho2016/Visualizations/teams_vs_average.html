<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>The Ocho</title>
    <link rel="stylesheet" href="https://reddigari.github.io/styles/ff_style.css">
    <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://reddigari.github.io/styles/style_functions.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.9.0/d3-legend.min.js"></script>
    <style>
    hr {
      margin: 25px 0px;
    }
    text {
      font-family: sans-serif;
    }
    div.tooltip {
      position: absolute;
      text-align: center;
      vertical-align: middle;
      width: auto;
      height: auto;
      padding: 8px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }
    </style>
</head>

<body>
    <div id="container">

        <div id="sidebar">
            <div id="field" style="padding:10px">
            </div>

            <ul>
                <li><a href="https://reddigari.github.io/fantasy2016">Posts</a></li>
                <li><a href="https://reddigari.github.io/fantasy2016/the_ocho" style="color: black">The Ocho</a></li>
                <li><a href="https://github.com/reddigari/football">Code</a></li>
            </ul>
        </div>

        <div id="header">
            <h1>Fantasy Football</h1>
        </div>
        <div id="text">
          <h2>The Ocho</h2>
            <div id="chart">
                <h2></h2>
                <script>
                    var margin = {
                            top: 50,
                            right: 20,
                            bottom: 20,
                            left: 60
                        },
                        width = 700 - margin.left - margin.right,
                        height = 1000 - margin.top - margin.bottom;

                    var xNeg = d3.scaleLinear()
                        .range([0, (width/2)-(width/50)]);

                    var xPos = d3.scaleLinear()
                        .range([(width/2)+(width/50), width]);

                    var y = d3.scaleBand()
                        .rangeRound([0, height])
                        .paddingInner(0.25)
                        .paddingOuter(0.1);

                    var y1 = d3.scaleBand()
                        .paddingInner(0.05);

                    var xAxisNeg = d3.axisTop(xNeg)
                        .ticks(5)
                        .tickFormat(d3.format(".0%"));
                    var xAxisPos = d3.axisTop(xPos)
                        .ticks(5)
                        .tickFormat(d3.format(".0%"));

                    var yAxis = d3.axisLeft(y)
                        .tickFormat('')
                        .tickSize(0);

                    var colorScale = d3.scaleLinear().range(["red", "white", "green"]);

                    var g = d3.select("#chart").append("svg")
                        .attr("width", width + margin.left + margin.right)
                        .attr("height", height + margin.top + margin.bottom)
                        .append("g")
                        .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    // d3.json("https://raw.githubusercontent.com/reddigari/football/master/TheOcho2016/Visualizations/wk1.json", function(json) {
                    d3.json("teams_vs_average.json", function(json) {

                        var max = d3.max(json, function(d) {
                            return d3.max(d.data, function(dd) {
                                return Math.abs(dd.Pct);
                            });
                        });

                        xNeg.domain([-max, 0]);
                        xPos.domain([0, max]);
                        colorScale.domain([-1, 0, 1]);

                        var owners = json.map(function(d) { return d.Owner; });
                        y.domain(owners);
                        var slots = json[0].data.map(function(d) { return d.Slot; });

                        y1.rangeRound([0, y.bandwidth()])
                            .domain(slots);

                        g.append("g")
                           .attr("class", "x axis")
                           .call(xAxisNeg);

                        g.append("g")
                           .attr("class", "x axis")
                           .call(xAxisPos);

                        var teams = g.selectAll(".team")
                            .data(json)
                            .enter().append("g")
                            .attr("class", "team")
                            .attr("transform", function(d) { return "translate(0," + y(d.Owner) + ")" });

                        teams.selectAll(".rect")
                            .data(function(d) {return d.data;})
                            .enter().append("rect")
                            .attr("class", "rect")
                            .attr("y", function(d) {return y1(d.Slot)})
                            .attr("height", y1.bandwidth())
                            .attr("x", function(d) {return (d.Pct > 0) ? xPos(0) : xNeg(d.Pct);})
                            .attr("width", function(d) {return (d.Pct > 0) ? (xPos(d.Pct) - xPos(0)): (xNeg(0)-xNeg(d.Pct));})
                            .style("fill", function(d) {return colorScale(d.Pct);})
                            .on("mouseover", function(d) {
                                tooltip.html(d.FFPts.toFixed(1))
                                .style("opacity", 0.8)
                                .style("left", (d3.event.pageX) + "px")
                                .style("top", (d3.event.pageY) + "px");
                            })
                            .on("mouseout", function() {tooltip.style("opacity", 0);});

                        teams.selectAll(".posLabel")
                            .data(slots)
                            .enter().append("text")
                            .text(function(d) {return d;})
                            .attr("y", function(d) {return y1(d) + 0.75*y1.bandwidth();})
                            .attr("x", width/2)
                            .attr("font-size", width/80)
                            .attr("text-anchor", "middle");

                        g.selectAll(".teamLabel")
                            .data(owners)
                            .enter().append("text")
                            .text(function(d) {return d})
                            .attr("y", function(d) {return y(d) + 0.5*y.bandwidth();})
                            .attr("text-anchor", "middle")
                            .attr("transform", function(d) {return "rotate(-90, 0," + (y(d) + 0.5*y.bandwidth()) + ")"});

                        g.selectAll(".divLine")
                            .data(owners.slice(1))
                            .enter().append("line")
                            .attr("class", "divLine")
                            .attr("x1", 0)
                            .attr("x2", width)
                            .attr("y1", function(d) { return y(d) - (0.5*y.paddingInner()*y.bandwidth()); })
                            .attr("y2", function(d) { return y(d) - (0.5*y.paddingInner()*y.bandwidth()); })
                            .style("stroke", "black");

                        g.append("text")
                            .attr("x", width/2)
                            .attr("y", -margin.top/1.5)
                            .text("Difference from League Average by Position")
                            .attr("font-size", "12")
                            .attr("text-anchor", "middle")

                        var smallHeight = 200;
                        var smallWidth = 400;
                        var totals = json.map(function(d) {
                            return {
                                Owner: d.Owner,
                                Record: d.Record,
                                Total: d3.sum(d.data, function(d) {return d.FFPts;})
                            }
                        });
                        totals.sort(function(a, b) { return a.Total < b.Total});

                        teamPts = d3.select("#chart").insert("svg", "svg:first-of-type")
                            .attr("width", smallWidth + margin.left + margin.right)
                            .attr("height", smallHeight + margin.top + margin.bottom)
                            .style("margin", "auto")
                            .style("display", "block")
                            .attr("transform", "translate(" + margin.left + "," + margin.top +")")
                            .append("g")
                            .attr("id", "teamPts");

                        var xOrd = d3.scaleBand()
                            .rangeRound([0, smallWidth])
                            .paddingInner(0.4)
                            .paddingOuter(0.3)
                            .domain(totals.map(function(d) {return d.Owner;}));

                        var y2 = d3.scaleLinear()
                            .range([smallHeight, 0])
                            .domain([0, d3.max(totals, function(d) {return d.Total;})+5]);

                        var xOrdAxis = d3.axisBottom(xOrd)
                            .tickSize(0)
                            .tickPadding(5);
                        var y2Axis = d3.axisLeft(y2)
                            .ticks(4);

                        teamPts.append("g")
                            .attr("class", "x axis")
                            .attr("transform", "translate(0," + smallHeight + ")")
                            .call(xOrdAxis);
                        teamPts.append("g")
                            .attr("class", "y axis")
                            .call(y2Axis)
                            .append("text")
                            .text("Average Fantasy Points")
                            .attr("dx", -0.5*smallHeight)
                            .attr("dy", -0.5*margin.left)
                            .attr("transform", "rotate(-90)")
                            .attr("font-size", 12)
                            .style("fill", "black")
                            .attr("text-anchor", "middle");
                        teamPts.append("text")
                            .attr("id", "lgAveLabel")
                            .attr("x", smallWidth)
                            .attr("y", y2(d3.mean(totals, function(d) {return d.Total;})))
                            .text("League Average")
                            .attr("text-anchor", "end")
                            .attr("font-size", 10)
                            .style("fill", "red");
                        teamPts.append("line")
                            .attr("x1", 0)
                            .attr("x2", smallWidth-75)
                            .attr("y1", y2(d3.mean(totals, function(d) {return d.Total;})))
                            .attr("y2", y2(d3.mean(totals, function(d) {return d.Total;})))
                            .style("stroke", "red");
                        teamPts.selectAll(".rect")
                            .data(totals)
                            .enter().append("rect")
                            .attr("x", function(d) {return xOrd(d.Owner);})
                            .attr("y", function(d) {return y2(d.Total);})
                            .attr("width", xOrd.bandwidth())
                            .attr("height", function(d) {return smallHeight-y2(d.Total)})
                            .style("fill", "#8c8c8c");
                        teamPts.selectAll(".ptsLabel")
                            .data(totals)
                            .enter().append("text")
                            .attr("x", function(d) {return xOrd(d.Owner) + 0.5*xOrd.bandwidth();})
                            .attr("y", function(d) {return y2(d.Total) + 12;})
                            .text(function(d) {return d.Total.toFixed(1)})
                            .attr("fill", "white")
                            .attr("font-size", 10)
                            .attr("text-anchor", "middle");
                        teamPts.selectAll(".recordLabel")
                            .data(totals)
                            .enter().append("text")
                            .attr("x", function(d) {return xOrd(d.Owner) + 0.5*xOrd.bandwidth();})
                            .attr("y", y2(0) - 10)
                            .text(function(d) {return d.Record})
                            .attr("fill", "black")
                            .attr("font-size", 10)
                            .attr("font-weight", "bold")
                            .attr("text-anchor", "middle");

                        d3.select("#chart").insert("hr", "svg:nth-of-type(2)");

                        var tooltip = d3.select("body").append("div")
                            .attr("class", "tooltip")
                            .style("opacity", 0);
                        // d3.select("#chart").insert("svg", "svg:first-of-type")
                        //     .attr("transform", "translate(" + margin.left + "," + margin.top +")")
                        //     .append("g")
                        //     .attr("class", "legendOrdinal");
                        //
                        // var legendOrdinal = d3.legendColor()
                        //   .shape("path", d3.symbol().type(d3.symbolCircle).size(60)())
                        //   .shapePadding(5)
                        //   .scale(colorScale);
                        //
                        // d3.select(".legendOrdinal")
                        //   .call(legendOrdinal);

                    });
                </script>
            </div>
        </div>
    </div>

</html>
