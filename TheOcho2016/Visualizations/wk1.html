<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>The Ocho: Week 1</title>
    <link rel="stylesheet" href="https://reddigari.github.io/styles/ff_style.css">
    <link href='https://fonts.googleapis.com/css?family=Inconsolata' rel='stylesheet' type='text/css'>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.6.1/css/font-awesome.min.css">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script src="https://reddigari.github.io/styles/style_functions.js"></script>
    <script src="https://d3js.org/d3.v4.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-legend/2.9.0/d3-legend.min.js"></script>
    <style>
    .projRect, .ptsRect {
      stroke-width: 0;
      stroke: none;
    }
    /*div.tooltip {
      position: absolute;
      text-align: center;
      vertical-align: middle;
      width: 60px;
      height: 28px;
      padding: 2px;
      font: 12px sans-serif;
      background: lightsteelblue;
      border: 0px;
      border-radius: 8px;
      pointer-events: none;
    }*/
    </style>
</head>

<body>
    <div id="container">

        <div id="sidebar">
            <div id="field" style="padding:10px">
                <svg width="180" height="80">
                    <line x1="2" x2="2" y1="0" y2="80" style="stroke: white; stroke-width:4px;" />
                    <line x1="178" x2="178" y1="0" y2="80" style="stroke: white; stroke-width:4px;" />
                    <line x1="0" x2="180" y1="78" y2="78" style="stroke: white; stroke-width:4px;" />
                    <line x1="0" x2="180" y1="2" y2="2" style="stroke: white; stroke-width:4px;" />
                    <rect x="4" y="4" width="16" height="72" style="stroke-width: 0; fill: blue;" />
                    <rect x="160" y="4" width="16" height="72" style="stroke-width: 0; fill: blue;" />
                    <line x1="20" x2="160" y1="35" y2="35" style="stroke: white; stroke-dasharray: 1, 1" />
                    <line x1="20" x2="160" y1="45" y2="45" style="stroke: white; stroke-dasharray: 1, 1" />
                </svg>
            </div>
            <script>
                var lines = [];
                for (count = 0; count < 21; count++) {
                    lines.push(20 + (7 * count));
                };
                d3.select("#field svg")
                    .selectAll(".ydline")
                    .data(lines)
                    .enter().append("line")
                    .style("stroke", "white")
                    .style("stroke-width", function(d, i) {
                        if (i % 2 == 0) return "2";
                        else return "1";
                    })
                    .attr("x1", function(d) {
                        return d;
                    })
                    .attr("x2", function(d) {
                        return d;
                    })
                    .attr("y1", 0)
                    .attr("y2", 80);
            </script>
            <ul>
                <li><a href=#>Posts</a></li>
                <li><a href=# style="color: black">The Ocho</a></li>
                <li><a href="https://github.com/reddigari/football">Code</a></li>
            </ul>
        </div>

        <div id="header">
            <h1>Fantasy Football</h1>
        </div>
        <div id="text">
            <div id="wk1Proj">
                <h2>The Ocho: Week 1</h2>
                <!-- <p>Here are the league average and individual projections for Week 1 (ESPN). As scores come in I'll add bars to show how each team performed vs. what was projected, instead of hastily removing any trace of the projections like ESPN does. I'm not sure how well this will adapt to lineup changes after tonight, but I'll try my best to keep it accurate.</p> -->
                <script>
                    var margin = {
                            top: 30,
                            right: 20,
                            bottom: 40,
                            left: 60
                        },
                        width = 350 - margin.left - margin.right,
                        height = 200 - margin.top - margin.bottom,
                        widthBig = 700 - margin.left - margin.right,
                        heightBig = 400 - margin.top - margin.bottom;

                    var y = d3.scaleLinear()
                        .range([height, 0]);

                    var x = d3.scaleBand()
                        .rangeRound([0, width])
                        .paddingInner(0.55)
                        .paddingOuter(0.1);

                    var xAxis = d3.axisBottom(x)
                        .tickSize(0)
                        .tickPadding(5);

                    var yAxis = d3.axisLeft(y)
                        .ticks(5);

                    var colors = ["#ff7f0e", "#2ca02c", "#d62728", "#1f77b4", "#9467bd", "#8c564b", "#e377c2", "#e8e91f", "#17becf"]
                    var colorScale = d3.scaleOrdinal(colors);

                    d3.json("wk1.json", function(json) {

                        json.forEach(function(d) {
                            d.data.forEach(function(dd) {
                                dd.proj = parseFloat(dd.proj);
                                dd.pts = parseFloat(dd.pts);
                            });
                        });

                        var max = d3.max(json, function(d) {
                            return d3.max(d.data, function(dd) {
                                return d3.max([dd.proj, dd.pts]);
                            });
                        });
                        var min = d3.min(json, function(d) {
                            return d3.min(d.data, function(dd) {
                                return d3.min([dd.proj, dd.pts]);
                            });
                        });
                        if (min > 0) min = 0;
                        y.domain([min, max]);

                        var owners = json.map(function(d) { return d.owner; });
                        colorScale.domain(owners)

                        var aveProj = {},
                            avePts = {},
                            slots = json[0].data.map(function(d) {
                                aveProj[d.Slot] = [];
                                avePts[d.Slot] = [];
                                return d.Slot;
                            });

                        x.domain(slots)

                        json.forEach(function(t) {
                            t.data.forEach(function(s) {
                                aveProj[s.Slot].push(s.proj);
                                avePts[s.Slot].push(s.pts);
                            });

                            var g = d3.select("#wk1Proj").append("svg")
                                .attr("class", "teamProj")
                                .attr("id", function() {
                                    return "team" + t.owner
                                })
                                .attr("width", width + margin.left + margin.right)
                                .attr("height", height + margin.top + margin.bottom)
                                .append("g")
                                .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                            g.append("g")
                                .attr("class", "x axis")
                                .attr("transform", "translate(0," + height + ")")
                                .call(xAxis);

                            g.append("g")
                                .attr("class", "y axis")
                                .attr("transform", "translate(-10,0)")
                                .call(yAxis)

                            g.selectAll(".ptsRect")
                                  .data(t.data, function(d) { return d.Slot; })
                                  .enter().append("rect")
                                  .attr("class", "ptsRect")
                                  .style("fill", colorScale(t.owner))
                                  .attr("x", function(d) { return x(d.Slot); })
                                  .attr("width", x.bandwidth())
                                  .attr("y", function(d) { if (isNaN(d.pts)) return null; else return y(d.pts); })
                                  .attr("height", function(d) { if (isNaN(d.pts)) return null; else return height-y(d.pts);});
                                  // .on("mouseover", function(d) {
                                  //     tooltip.html(d.player)
                                  //     .style("opacity", 0.8)
                                  //     .style("left", (d3.event.pageX) + "px")
                                  //     .style("top", (d3.event.pageY) + "px");
                                  // })
                                  // .on("mouseout", function() {tooltip.style("opacity", 0);});

                            g.selectAll(".projLine")
                                .data(t.data, function(d) { return d.Slot; })
                                .enter().append("line")
                                .attr("class", "projLine")
                                // .style("stroke", colorScale(t.owner))
                                .style("stroke", "black")
                                .attr("x1", function(d) { return x(d.Slot); })
                                .attr("x2", function(d) { return x(d.Slot) + x.bandwidth(); })
                                .attr("y1", function(d) { return y(d.proj); })
                                .attr("y2", function(d) { return y(d.proj); });
                                // .on("mouseover", function(d) {
                                //     tooltip.html(d.player)
                                //     .style("opacity", 0.8)
                                //     .style("left", (d3.event.pageX) + "px")
                                //     .style("top", (d3.event.pageY) + "px");
                                // })
                                // .on("mouseout", function() {tooltip.style("opacity", 0);});


                            g.selectAll(".projLabel")
                                .data(t.data, function(d) { return d.Slot; })
                                .enter().append("text")
                                .attr("class", "projLabel")
                                // .transition()
                                .attr("x", function(d) { return x(d.Slot) + x.bandwidth() + 2; })
                                .attr("y", function(d) { return y(d.proj) + 3; })
                                .text(function(d) { return d.proj.toFixed(1); })
                                .attr("font-size", "8")
                                .attr("font-family", "sans-serif")
                                .attr("text-anchor", "start");

                            g.selectAll(".ptsLabel")
                                .data(t.data, function(d) { return d.Slot; })
                                .enter().append("text")
                                .attr("class", "projLabel")
                                // .transition()
                                .attr("x", function(d) { return x(d.Slot) + 0.5*x.bandwidth(); })
                                .attr("y", function(d) { if (d.pts >= d.proj) return y(d.pts) - 2; else return y(d.pts) + 8;})
                                .text(function(d) { if (isNaN(d.pts)) return null; else return d.pts.toFixed(1); })
                                .attr("font-size", "8")
                                .attr("font-family", "sans-serif")
                                .attr("text-anchor", "middle");

                            g.append("text")
                                // .attr("x", 0.5 * width)
                                .attr("y", 0 - (0.5 * margin.top))
                                .text(t.owner)
                                .attr("text-anchor", "start")
                                .attr("font-size", "14")
                                .style("fill", colorScale(t.owner));
                            g.append("text")
                                .attr("id", function() { return "projVal" + t.owner})
                                .attr("x", width)
                                .attr("y", 0 - (0.5 * margin.top))
                                .text("Projected: " + d3.sum(t.data, function(d) { return d.proj; }).toFixed(1))
                                .attr("text-anchor", "end")
                                .attr("font-size", "10")
                                .attr("font-family", "sans-serif");
                            g.append("text")
                                .attr("x", width)
                                .attr("y", 0 - (0.5 * margin.top))
                                .attr("dy", 10)
                                .text("Actual: " + d3.sum(t.data, function(d) { return d.pts; }).toFixed(1))
                                .attr("text-anchor", "end")
                                .attr("font-size", "10")
                                .attr("font-family", "sans-serif");
                        });

                    // transform average data into list and make chart of means
                    aveData = slots.map(function(s) {
                        var obj = {};
                        obj['Slot'] = s;
                        obj['proj'] = aveProj[s];
                        obj['pts'] = avePts[s];
                        // obj['pts'] = avePts[s].filter(function(a) {return !(a==0);});
                        return obj;
                    });

                    g = d3.select("#wk1Proj").insert("svg", "svg:first-of-type")
                            .attr("class", "teamProj")
                            .attr("id", "meanChart")
                            .attr("width", widthBig + margin.left + margin.right)
                            .attr("height", heightBig + margin.top + margin.bottom)
                            .append("g")
                            .attr("transform", "translate(" + margin.left + "," + margin.top + ")");

                    x.rangeRound([0, widthBig]).paddingInner(0.3);
                    y.range([heightBig, 0]);
                    var x1 = d3.scaleBand()
                        .domain([0,1])
                        .rangeRound([0, x.bandwidth()])
                        .paddingInner(0.05);

                    g.append("g")
                        .attr("class", "x axis")
                        .attr("transform", "translate(0," + heightBig + ")")
                        .call(xAxis.tickPadding(18));

                    g.append("g")
                        .attr("class", "y axis")
                        .attr("transform", "translate(-10,0)")
                        .call(yAxis)
                        .append("text")
                        .attr("y", heightBig / 2)
                        .attr("x", -30)
                        .attr("fill", "black")
                        .style("text-anchor", "middle")
                        .text("Fantasy Points")
                        .attr("transform", "rotate(-90," + "-30," + heightBig / 2 + ")");

                    var slotGroups = g.selectAll(".slot")
                        .data(aveData)
                        .enter().append("g")
                        .attr("class", "slot")
                        .attr("id", function(d) { return "bars"+d.Slot; })
                        .attr("transform", function(d) { return "translate(" + x(d.Slot) + ",0)"; });

                    slotGroups.selectAll(".rect")
                        .data(function(d) {return [d.proj, d.pts.filter(function(a) {return (!(isNaN(a)));})];})
                        .enter().append("rect")
                        .attr("class", "rect")
                        .attr("x", function(d, i) { return x1(i); })
                        .attr("y", function(d) { if (d.length > 0) return y(d3.mean(d)); else return null; })
                        .attr("height", function(d) { if (d.length > 0) return heightBig-y(d3.mean(d)); else return null; })
                        .attr("width", x1.bandwidth())
                        .style("fill", function(d, i) {if (i==0) return "#bdbdbd"; else return "#9f9f9f"});

                    slotGroups.selectAll(".valLabel")
                        .data(function(d) {return [d.proj, d.pts.filter(function(a) {return (!(isNaN(a)));})]; })
                        .enter().append("text")
                        .attr("x", function(d, i) { return x1(i) + 0.5*x1.bandwidth(); })
                        // .attr("y", function(d) { if (d.length > 0) return y(d3.mean(d)) - 2; else return null; })
                        .attr("y", y(1))
                        .text(function(d) { if (d.length > 0) return d3.mean(d).toFixed(1); else return null; })
                        .attr("text-anchor", "middle")
                        .attr("fill", "black")
                        .attr("font-family", "sans-serif")
                        .attr("font-size", 10);

                    slotGroups.selectAll(".colLabel")
                        .data(['Proj.', 'Real'])
                        .enter().append("text")
                        .attr("x", function(d, i) { return x1(i) + 0.5*x1.bandwidth(); })
                        .attr("y", heightBig + 13)
                        .text(function(d) { return d; })
                        .attr("text-anchor", "middle")
                        .attr("fill", "black")
                        .attr("font-family", "sans-serif")
                        .attr("font-size", 10);

                    var markerWidth = 10;
                    slotGroups.selectAll(".projDot")
                        .data(function(d) { return d.proj; })
                        .enter().append("rect")
                        .attr("class", "projDot")
                        .style("fill", function(d, i) {return colorScale(owners[i]);})
                        .style("stroke-width", 0)
                        .attr("x", x1(0) + 0.5*x1.bandwidth() - 0.5*markerWidth)
                        .attr("y", function(d) { return y(d); })
                        .attr("width", markerWidth)
                        .attr("height", 2);

                    slotGroups.selectAll(".ptsDot")
                        .data(function(d) { return d.pts; })
                        .enter().append("rect")
                        .attr("class", "ptsDot")
                        .style("fill", function(d, i) {return colorScale(owners[i]);})
                        .style("stroke-width", 0)
                        .attr("x", x1(1) + 0.5*x1.bandwidth() - 0.5*markerWidth)
                        .attr("y", function(d) { if (isNaN(d)) return null; else return y(d); })
                        .attr("width", function(d) {if (isNaN(d)) return 0; else return markerWidth;})
                        .attr("height", function(d) {if (isNaN(d)) return 0; else return 3;});

                    d3.selectAll("#meanChart .x.axis text").attr("font-weight", "bold");

                    g.append("g")
                      .attr("class", "legendOrdinal")
                      .attr("transform", "translate(" + (widthBig-60) +",20)");

                    var legendOrdinal = d3.legendColor()
                      .shape("path", d3.symbol().type(d3.symbolCircle).size(60)())
                      .shapePadding(5)
                      .scale(colorScale);

                    g.select(".legendOrdinal")
                      .call(legendOrdinal);


                    });

                    var tooltip = d3.select("body").append("div")
                        .attr("class", "tooltip")
                        .style("opacity", 0);
                </script>
            </div>
        </div>
    </div>

</html>
